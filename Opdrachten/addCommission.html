<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Workshop toevoegen</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="addcommission.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  </head>
  <body>
    <nav-bar></nav-bar>
    <side-nav></side-nav>
    <script src="../adminnavcomponents.js"></script>
    <!-- de links werken niet omdat ze niet allemaal in hetzelfde mapje zitten -->
  
    <!-- popup -->
    <div class="alert alert-success" role="alert" style="display: none;">
      <strong>Succes!</strong> Opdracht is succesvol toegevoegd.
    </div>
    <div class="container mt-5">
      <div class="content">

        <h1>Voeg een opdracht toe</h1>
        <form id="commissionForm">
          <div class="form-group mb-3">
            <label for="commissionName">Naam Opdracht *</label>
            <input required type="text" class="form-control" id="commissionName" name="commissionName" placeholder="Voer de naam van de opdracht in" required>
          </div>
          <div class="row">
            <div class="form-group col-md-6">
              <label for="mySelectedClient">Klant *</label>
              <select required class="form-select" name="mySelectedClient" id="mySelectedClient">
                <option selected>Selecteer een klant</option>
              </select> 
            </div>
            <div class="form-group col-md-6">
              <label for="address">Adres *</label>
              <input required type="text" class="form-control" name="address" id="address" rows="3" placeholder="Voer het adres in"></input>
            </div> 
          </div>
          <div class="form-group mb-3">
            <label for="date">Datum *</label>
            <input required type="date" class="form-control" name="date" id="date" rows="3" placeholder="Voer de datum in"></input>
          </div> 
          <div class="form-group mb-3">
            <label for="notes">Extra Toelichting</label>
            <textarea class="form-control" name="notes" id="notes" rows="3" placeholder="Voer de benodigde extra toelichtingen in, indien nodig"></textarea>
          </div>
          <div class="form-group mb-3" id="new-input-container"></div>
          <p class="add-new-shareholders-p">
            <button type="button" class="btn btn-primary add-workshop-btn">Workshops toevoegen +</button>
          </p>
          <button type="submit" class="btn btn-primary">Voeg de opdracht toe</button>
        </form>
      </div>
    </div>

    <script>
      // Fetch client names from the server
      fetch('https://skoolworkshopapi.azurewebsites.net/client/allnames')
        .then(response => response.json())
        .then(data => {
          const select = document.getElementById('mySelectedClient');
          data.data.forEach(item => {
            const option = document.createElement('option');
            option.value = item.ClientName;
            option.textContent = item.ClientName;
            select.appendChild(option);
          });
        })
        .catch(error => {
          console.error('Error fetching client names:', error);
        });

      // Fetch workshop names from the server
      let workshopOptions = '';
      fetch('https://skoolworkshopapi.azurewebsites.net/workshop/allnames')
        .then(response => response.json())
        .then(data => {
          data.data.forEach(item => {
            workshopOptions += `<option value="${item.WorkshopName}">${item.WorkshopName}</option>`;
          });
        })
        .catch(error => {
          console.error('Error fetching workshop names:', error);
        });

      document.querySelector('.add-workshop-btn').addEventListener('click', createNewInputFields);

      function createNewInputFields() {
        const container = document.getElementById('new-input-container');
        const inputHtml = `
          <div class="form-container mt-5">
            <div class="content-extra-box">
              <button type="button" class="close-btn" onclick="removeForm(this)">X</button>
              <p><b>Voeg een workshop toe</b></p>
              <div class="set-center">
                <div class="form-group mb-3">
                  <label for="workshop">Workshop *</label>
                  <select required class="form-select" name="workshop">
                    <option selected>Selecteer een workshop</option>
                    ${workshopOptions}
                  </select>
                </div>
                <div class="row">
                  <div class="form-group col-md-6">
                    <label for="teachersNeeded">Aantal docenten *</label>
                    <input required type="number" class="form-control" name="teachersNeeded" placeholder="Voer het aantal nodige docenten in">
                  </div> 
                  <div class="form-group col-md-6">
                    <label for="participants">Aantal deelnemers *</label>
                    <input required type="number" class="form-control" name="participants" placeholder="Voer het aantal deelnemers in">
                  </div> 
                </div>
                <div class="row">
                  <div class="form-group col-md-6">
                    <label for="grade">Leerjaar</label>
                    <input type="text" class="form-control" name="grade" placeholder="Voer het leerjaar in">
                  </div> 
                  <div class="form-group col-md-6">
                    <label for="level">Niveau</label>
                    <select required class="form-select" name="level">
                      <option selected>Selecteer een niveau</option>
                      <option value="beginner">Beginner</option>
                      <option value="gevorderd">Gevorderd</option>
                    </select>
                  </div> 
                </div>
                <div class="row">
                  <div class="form-group col-md-6">
                    <label for="startTime">Begintijd *</label>
                    <input type="time" class="form-control" name="startTime"></input>
                  </div>
                  <div class="form-group col-md-6">
                    <label for="endTime">Eindtijd *</label>
                    <input type="time" class="form-control" name="endTime"></input>
                  </div>
                </div><br>
                <div class="form-group md-3">Duur van de workshop: X minuten</div><br>
                <div class="form-group md-3">
                  <label for="location">Werklocatie</label>
                  <input type="text" class="form-control" name="location" placeholder="Werklocatie, indien afwijkend"></input>
                </div>
                <div class="form-group md-3">
                  <label for="workshopNotes">Notities</label>
                  <textarea class="form-control" name="workshopNotes" placeholder="Voer notities in"></textarea>
                </div>
              </div>
            </div>
          </div>
        `;
        container.insertAdjacentHTML('beforeend', inputHtml);
      }

      function removeForm(button) {
        button.closest('.form-container').remove();
      }

      // Add to the database (for now only the 'opdracht' parts)
  document.getElementById('commissionForm').addEventListener('submit', async function(event) {
  event.preventDefault();
  
  // Values
  const commissionName = document.getElementById('commissionName').value;
  const clientName = document.getElementById('mySelectedClient').value;
  const address = document.getElementById('address').value;
  const date = document.getElementById('date').value;
  const commissionNotes = document.getElementById('notes').value;

  // Workshop values
  const workshops = [];
  document.querySelectorAll('.form-container').forEach(container => {
    const workshopName = container.querySelector('select[name="workshop"]').value;
    const maxUsers = container.querySelector('input[name="teachersNeeded"]').value;
    const numberOfParticipants = container.querySelector('input[name="participants"]').value;
    const targetGroup = container.querySelector('input[name="grade"]').value;
    const level = container.querySelector('select[name="level"]').value;
    const startTime = container.querySelector('input[name="startTime"]').value;
    const endTime = container.querySelector('input[name="endTime"]').value;
    const location = container.querySelector('input[name="location"]').value;
    const workshopNotes = container.querySelector('textarea[name="workshopNotes"]').value;
    workshops.push({
      workshopname: workshopName,
      maxusers: maxUsers,
      numberofparticipents: numberOfParticipants,
      targetgroup: targetGroup,
      level: level,
      starttime: startTime,
      endtime: endTime,
      location: location,
      workshopnotes: workshopNotes
    });
  });

  // Object creation
  const formObject = {
    commissionname: commissionName,
    clientname: clientName,
    address: address,
    date: date,
    commissionnotes: commissionNotes,
    workshops: workshops
  };

  console.log(formObject);

  const apiUrl = 'https://skoolworkshopapi.azurewebsites.net/commission/add';
  try {
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(formObject)
    });
    if(response.ok){
      console.log('Opdracht toegevoegd');
      const result = await response.json();
      // Show success popup
      showPopup();
      // Clear form
      document.getElementById('commissionForm').reset();
      document.getElementById('new-input-container').innerHTML = '';
    } else {
      console.error('Opdracht niet toegevoegd');
    }
  } catch (error) {
    console.error('Error:', error);
  }
});

function showPopup() {
  const successPopup = document.querySelector('.alert-success');
  successPopup.style.display = 'block';
  setTimeout(() => {
    successPopup.style.display = 'none';
  }, 3000);
}


      // Fetch client address when a client is selected
      document.getElementById('mySelectedClient').addEventListener('change', function() {
        const clientName = this.value;
        if (clientName !== 'Selecteer een klant') {
          fetchClientAddress(clientName);
        }
      });

      function fetchClientAddress(clientName) {
        const apiUrl = 'https://skoolworkshopapi.azurewebsites.net/client/address';
        const requestData = {
            clientname: clientName
        };

        fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 200 && data.data.length > 0) {
                const address = data.data[0].Address;
                document.getElementById('address').value = address;
                document.querySelectorAll('input[name="location"]').forEach(input => {
                    if (input.closest('.form-container')) {
                        input.value = address;
                    }
                });
            } else {
                console.error('No address found for client');
            }
        })
        .catch(error => {
            console.error('Error fetching client address:', error);
        });
    }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  </body>
</html>
