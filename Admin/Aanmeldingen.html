<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aanmeldingen</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="addWorkshops.css">
    <link rel="stylesheet" href="adminstyles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!-- overall css admin zoals voor nav -->
    <style>
        /* Custom CSS to ensure button colors */
        .btn-success {
            background-color: #28a745 !important; /* Bootstrap's green */
            border-color: #28a745 !important;
        }

        .btn-danger {
            background-color: #dc3545 !important; /* Bootstrap's red */
            border-color: #dc3545 !important;
        }

        .btn-success span, .btn-danger span {
            color: white !important; /* Ensuring the icon color is white */
        }
    </style>
</head>
<body>

    <div class="sidenav">
        <ul class="nav flex-column">
          <li>
            <a class="nav-link" href="adminDashboard.html"><span class="bi bi-speedometer2"></span> Dashboard</a>
          </li>
          <li>
            <a class="nav-link" href="#"> <span class="bi bi-person-arms-up"></span> Workshops</a>
          </li>
          <li>
            <a class="nav-link" href="#"> <span class="bi bi-calendar"></span> Opdrachten</a>
          </li>
          <li>
            <a class="nav-link" href="#"><span class="bi bi-person"></span> Klanten</a>
          </li>
          <li>
            <a class="nav-link" href="assignmentOverview.html"><span class="bi bi-suitcase-lg"></span> Docenten</a>
          </li>
          <li><a class="nav-link" href="EmailTemplatesPage.html"><span class="bi bi-mailbox"></span> Email Templates</a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="sidebardropdown" role="button" aria-haspopup="true" aria-expanded="false">
              <span class="bi bi-plus-lg"></span> Nieuw
            </a>
            <ul class="dropdown-menu" aria-labelledby="sidebardropdown">
              <li><a class="dropdown-item" href="addWorkshops.html">Workshop</a></li>
              <li><a class="dropdown-item" href="addCommission.html">Opdracht</a></li>
              <li><a class="dropdown-item" href="registerClient.html">Klant</a></li>
            </ul>
          </li>
        </ul>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="./Homepage/Homepage.html">
                <img src="../Images/SKWLogoTransparentWhite.png" alt="Logo" width="75" height="44" class="d-inline-block align-text-top">
            </a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="bi bi-person"></i>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    

    <div class="container mt-5">
        <div class="content" id="clickable">
            <h1 class="text-center">Aanmeldingen docenten</h1><br>
            <div class="list-group" id="registration-list">
                <!-- List items will be inserted here -->
            </div>
            <h1 class="text-center">Aanmeldingen workshops</h1><br>
            <div class="list-group" id="workshop-registration-list">
                <!-- List items will be inserted here -->
            </div>
            <h1 class="text-center">Opdrachten zonder toegewezen gebruikers</h1><br>
            <div class="list-group" id="no-user-job-list">
                <!-- List items will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // klik op de card en ga naar de profielpagina
            document.getElementById("clickable").addEventListener("click", () => {
                window.location.href = "./selectedAccount.html";
            });
        })
    </script>

    <script>
        // Fetch data from the backend
        $.ajax({
            url: 'https://skoolworkshopapi.azurewebsites.net/user/basic',  
            method: 'GET',
            success: function(response) {
                if (response.status === 200) {
                    const data = response.data;
                    data.forEach(function(user) {
                        const listItem = `
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${user.Username}</strong><br>
                                    <span>${user.Email}</span><br>
                                    <span>${user.Role}</span><br>
                                    <span><a href="selectedAccount.html?userId=${user.UserId}">View Details</a></span> <!-- Link to another page with userId -->
                                </div>
                                <div>
                                    <button class="btn btn-success btn-sm mr-2" onclick="handleAccept('${user.Username}')">
                                        <span style="color: white;">✔</span>
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="handleReject('${user.Username}')">
                                        <span style="color: white;">✖</span>
                                    </button>
                                </div>
                            </div>
                        `;
                        $('#registration-list').append(listItem);
                    });
                } else {
                    $('#registration-list').append('<div class="alert alert-warning">No users found with the given status.</div>');
                }
            },
            error: function(error) {
                console.error("Er zijn geen nieuwe aanmedlingen", error);
                $('#registration-list').append('<div class="alert alert-danger">Er zijn geen nieuwe aanmeldingen.</div>');
            }
        });

        function handleAccept(username) {
            updateUserStatus(username, 'Toegewezen');
        }

        function handleReject(username) {
            deleteUser(username);
        }

        function updateUserStatus(username, status) {
            $.ajax({
                url: 'https://skoolworkshopapi.azurewebsites.net/user/updateStatus',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ Username: username, status: status }),
                success: function(response) {
                    if (response.status === 200) {
                        alert('User status updated successfully');
                        // Optionally, remove the user from the list
                        $(`#user-${username}`).remove();
                    } else {
                        alert('Failed to update user status');
                    }
                },
                error: function(error) {
                    console.error("There was an error updating the user status", error);
                    alert('Error updating user status');
                }
            });
        }

        function deleteUser(username) {
            $.ajax({
                url: 'https://skoolworkshopapi.azurewebsites.net/user/delete',
                method: 'DELETE',
                contentType: 'application/json',
                data: JSON.stringify({ Username: username }), // Use 'Username' in the request body
                success: function(response) {
                    if (response.status === 200) {
                        alert('User deleted successfully');
                        // Remove the user from the list
                        $(`#user-${username}`).remove();
                    } else {
                        alert('Failed to delete user');
                    }
                },
                error: function(error) {
                    console.error("There was an error deleting the user", error);
                    alert('Error deleting user');
                }
            });
        }

        // Fetch data from the backend for jobs with no assigned users
        $.ajax({
            url: 'https://skoolworkshopapi.azurewebsites.net/workshopcommission/status/unassigned',
            method: 'GET',
            success: function(response) {
                if (response.status === 200) {
                    const data = response.data;
                    console.log(data);
                    data.forEach(function(job) {
                        const listItem = `
                            <div class="list-group-item d-flex justify-content-between align-items-center" id="job-${job.CommissionWorkshopId}">
                                <div>
                                    <span><strong>${job.Username}</strong></span><br>
                                    <span>${job.WorkshopName}</span><br>
                                    <span>Locatie: ${job.Location}</span> <br>
                                    <span>Klantnaam: ${job.ClientName}</span> <br>
                                    <span>Categorie: ${job.Category}</span>
                                </div>
                                <div>
                                    <button class="btn btn-success btn-sm mr-2" onclick="assignJob('${job.CommissionWorkshopId}', '${job.UserId}')">
                                        <span style="color: white;">✔</span>
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="rejectJob('${job.CommissionWorkshopId}')">
                                        <span style="color: white;">✖</span>
                                    </button>
                                </div>
                            </div>
                        `;
                        $('#workshop-registration-list').append(listItem);
                    });
                } else {
                    $('#no-user-job-list').append('<div class="alert alert-warning">No jobs found with no assigned users.</div>');
                }
            },
            error: function(error) {
                console.error("There was an error fetching jobs with no assigned users", error);
                $('#no-user-job-list').append('<div class="alert alert-danger">Error fetching jobs with no assigned users.</div>');
            }
        });

        function assignJob(commissionWorkshopId, userId) {
            updateJobStatus(commissionWorkshopId, userId);
        }

        function rejectJob(commissionWorkshopId) {
            deleteJob(commissionWorkshopId);
        }

        function updateJobStatus(commissionWorkshopId, userId) {
            $.ajax({
                url: 'https://skoolworkshopapi.azurewebsites.net/workshopcommissionuser/updateStatus',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ commissionWorkshopId: commissionWorkshopId, userId: userId }), // Ensure keys match exactly with backend expectation
                success: function(response) {
                    if (response.status === 200) {
                        alert('Job status updated successfully');
                        // Optionally, remove the job from the list
                        $(`#job-${commissionWorkshopId}`).remove();
                    } else {
                        alert('Failed to update job status');
                        console.log(response, commissionWorkshopId, userId);
                    }
                },
                error: function(error) {
                    console.error("There was an error updating the job status", error);
                    alert('Error updating job status');
                    console.log(commissionWorkshopId, userId);
                }
            });
        }

        function deleteJob(commissionWorkshopId) {
            $.ajax({
                url: 'https://skoolworkshopapi.azurewebsites.net/workshopcommission/delete',
                method: 'DELETE',
                contentType: 'application/json',
                data: JSON.stringify({ CommissionWorkshopId: commissionWorkshopId }), // Use 'CommissionWorkshopId' in the request body
                success: function(response) {
                    if (response.status === 200) {
                        alert('Job deleted successfully');
                        // Remove the job from the list
                        $(`#job-${commissionWorkshopId}`).remove();
                    } else {
                        alert('Failed to delete job');
                    }
                },
                error: function(error) {
                    console.error("There was an error deleting the job", error);
                    alert('Error deleting job');
                }
            });
        }

        function viewJobDetails(commissionWorkshopId) {
            // Redirect to another screen or page to view the job details
            window.location.href = `jobDetails.html?id=${commissionWorkshopId}`;
        }
    </script>

</body>
</html>
